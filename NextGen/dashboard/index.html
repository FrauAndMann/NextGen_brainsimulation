<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYNAPSE Control Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #0a0e17;
            color: #e0e0e0;
            min-height: 100vh;
        }
        .container { padding: 20px; max-width: 1400px; margin: 0 auto; }

        /* Header */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px;
            background: linear-gradient(180deg, #0d1220 0%, #0a0e17 100%);
            border-bottom: 1px solid #1a2332;
            margin-bottom: 20px;
        }
        .logo { display: flex; align-items: center; gap: 10px; }
        .logo-dot {
            width: 12px; height: 12px; border-radius: 50%;
            background: #4ecdc4; box-shadow: 0 0 10px #4ecdc4;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .logo-text { font-size: 20px; font-weight: 600; color: #fff; }
        .status-badge {
            padding: 6px 14px; border-radius: 20px; font-size: 12px;
            font-weight: 500; text-transform: uppercase;
        }
        .status-idle { background: #2a2a2a; color: #888; }
        .status-running { background: rgba(78,205,196,0.2); color: #4ecdc4; }
        .status-paused { background: rgba(255,217,61,0.2); color: #ffd93d; }

        /* Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 300px 1fr 280px;
            gap: 20px;
        }

        /* Cards */
        .card {
            background: #0d1220;
            border: 1px solid #1a2332;
            border-radius: 12px;
            overflow: hidden;
        }
        .card-header {
            padding: 12px 16px;
            background: #0a0e17;
            border-bottom: 1px solid #1a2332;
            font-size: 12px;
            color: #8892a0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .card-body { padding: 16px; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none; border-radius: 8px;
            font-size: 13px; font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: #4ecdc4; color: #000; }
        .btn-success { background: #a8e6cf; color: #000; }
        .btn-warning { background: #ffd93d; color: #000; }
        .btn-danger { background: #ff6b9d; color: #000; }
        .btn-secondary { background: #2a3444; color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-block { width: 100%; justify-content: center; }

        /* Inputs */
        .input-group { margin-bottom: 12px; }
        .input-label { display: block; font-size: 11px; color: #6b7280; margin-bottom: 4px; }
        .input {
            width: 100%; padding: 10px 12px;
            background: #0a0e17; border: 1px solid #1a2332;
            border-radius: 8px; color: #fff; font-size: 13px;
        }
        .input:focus { outline: none; border-color: #4ecdc4; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* Metrics */
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .metric-card {
            background: linear-gradient(135deg, #0d1220, #0a0e17);
            border: 1px solid #1a2332;
            border-radius: 10px; padding: 16px;
        }
        .metric-label { font-size: 10px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; }
        .metric-value { font-size: 24px; font-weight: 600; }
        .metric-phi { color: #ffd93d; }
        .metric-agency { color: #a8e6cf; }
        .metric-integration { color: #4ecdc4; }
        .metric-confidence { color: #96ceb4; }

        /* Chart */
        .chart-container { height: 300px; margin-top: 10px; }

        /* Gauges */
        .gauge { margin-bottom: 14px; }
        .gauge-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .gauge-label { font-size: 11px; color: #8892a0; }
        .gauge-value { font-size: 11px; font-weight: 600; }
        .gauge-bar { height: 6px; background: #1a2332; border-radius: 3px; overflow: hidden; }
        .gauge-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }

        /* Checkpoint list */
        .checkpoint-list { max-height: 200px; overflow-y: auto; }
        .checkpoint-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; margin-bottom: 8px;
            background: #0a0e17; border-radius: 8px;
        }
        .checkpoint-info { font-size: 11px; }
        .checkpoint-name { color: #8892a0; }
        .checkpoint-size { color: #4a5568; font-size: 10px; }

        /* Chat */
        .chat-container { display: flex; flex-direction: column; height: 100%; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; }
        .chat-message { margin-bottom: 10px; }
        .chat-bubble {
            max-width: 85%; padding: 10px 14px; border-radius: 12px;
            font-size: 12px; line-height: 1.5;
        }
        .chat-bubble-user {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            margin-left: auto;
        }
        .chat-bubble-brain {
            background: #1a2332;
        }
        .chat-input-container {
            padding: 10px;
            border-top: 1px solid #1a2332;
            display: flex; gap: 8px;
        }
        .chat-input {
            flex: 1; padding: 10px 14px;
            background: #0a0e17; border: 1px solid #1a2332;
            border-radius: 8px; color: #fff; font-size: 12px;
        }

        /* Info bar */
        .info-bar {
            display: flex; gap: 20px;
            font-size: 11px; color: #6b7280;
        }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: #4ecdc4; }
    </style>
</head>
<body>
    <div id="root"><div class="loading">Loading SYNAPSE Dashboard...</div></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API = "http://localhost:8000";

        // API helper
        async function api(path, method = "GET", body = null) {
            try {
                const opts = { method, headers: { "Content-Type": "application/json" } };
                if (body) opts.body = JSON.stringify(body);
                const res = await fetch(API + path, opts);
                return await res.json();
            } catch (e) {
                console.error("API error:", e);
                return null;
            }
        }

        function App() {
            // State
            const [status, setStatus] = useState({ state: "idle", step: 0, elapsed_human: "0s", total_neurons: 0 });
            const [metrics, setMetrics] = useState({ phi: 0, mean_agency: 0, integration_score: 0, meta_confidence: 0 });
            const [neuro, setNeuro] = useState({ dopamine: 0.5, serotonin: 0.5, oxytocin: 0.5, cortisol: 0.3, norepinephrine: 0.4 });
            const [checkpoints, setCheckpoints] = useState([]);
            const [messages, setMessages] = useState([]);
            const [chatInput, setChatInput] = useState("");
            const [connected, setConnected] = useState(false);

            // Stop conditions
            const [maxSteps, setMaxSteps] = useState("");
            const [maxHours, setMaxHours] = useState("");
            const [targetPhi, setTargetPhi] = useState("");
            const [targetAgency, setTargetAgency] = useState("");

            // Neurogenesis
            const [neuroEnabled, setNeuroEnabled] = useState(true);
            const [maxNeurons, setMaxNeurons] = useState("100000");
            const [growthThreshold, setGrowthThreshold] = useState("0.85");

            const wsRef = useRef();
            const chatRef = useRef();

            // WebSocket connection
            useEffect(() => {
                let ws;
                const connect = () => {
                    ws = new WebSocket("ws://localhost:8000/ws");
                    ws.onopen = () => setConnected(true);
                    ws.onmessage = (e) => {
                        const data = JSON.parse(e.data);
                        if (data.state) setStatus(prev => ({ ...prev, ...data }));
                        if (data.metrics) setMetrics(data.metrics);
                    };
                    ws.onclose = () => {
                        setConnected(false);
                        setTimeout(connect, 2000);
                    };
                    wsRef.current = ws;
                };
                connect();
                return () => ws?.close();
            }, []);

            // Load initial data
            useEffect(() => {
                const load = async () => {
                    const s = await api("/api/status");
                    if (s) setStatus(prev => ({ ...prev, ...s }));

                    const c = await api("/api/checkpoints");
                    if (c) setCheckpoints(c);

                    const h = await api("/api/chat/history");
                    if (h) setMessages(h);
                };
                load();
                const iv = setInterval(load, 10000);
                return () => clearInterval(iv);
            }, []);

            // Scroll chat
            useEffect(() => {
                if (chatRef.current) chatRef.current.scrollTop = chatRef.current.scrollHeight;
            }, [messages]);

            // Actions
            const start = () => api("/api/training/start", "POST");
            const pause = () => api("/api/training/pause", "POST");
            const resume = () => api("/api/training/resume", "POST");
            const stop = () => {
                if (confirm("Stop training? Progress will be saved.")) {
                    api("/api/training/stop", "POST");
                }
            };

            const setStopCond = async () => {
                const body = {};
                if (maxSteps) body.max_steps = parseInt(maxSteps);
                if (maxHours) body.max_hours = parseFloat(maxHours);
                if (targetPhi) body.target_phi = parseFloat(targetPhi);
                if (targetAgency) body.target_agency = parseFloat(targetAgency);
                await api("/api/training/stop-conditions", "POST", body);
                alert("Stop conditions applied!");
            };

            const setNeuroCfg = async () => {
                await api("/api/neurogenesis/config", "POST", {
                    enabled: neuroEnabled,
                    max_neurons: parseInt(maxNeurons),
                    activation_threshold: parseFloat(growthThreshold)
                });
                alert("Neurogenesis config updated!");
            };

            const saveCkpt = async () => {
                const res = await api("/api/checkpoint/save", "POST");
                if (res) alert("Saved: " + res.path);
                // Reload list
                const c = await api("/api/checkpoints");
                if (c) setCheckpoints(c);
            };

            const loadCkpt = async (path) => {
                if (confirm("Load checkpoint? Current progress will be lost.")) {
                    await api("/api/checkpoint/load?path=" + encodeURIComponent(path), "POST");
                    alert("Loaded!");
                }
            };

            const resetModel = async () => {
                if (confirm("Reset model? ALL progress will be lost!")) {
                    await api("/api/reset", "POST");
                    alert("Model reset.");
                }
            };

            const sendChat = async () => {
                if (!chatInput.trim()) return;
                const text = chatInput;
                setChatInput("");
                setMessages(prev => [...prev, { from: "user", text, timestamp: new Date().toISOString() }]);
                const res = await api("/api/chat", "POST", { text });
                if (res) {
                    setMessages(prev => [...prev, { from: "brain", text: res.response, timestamp: new Date().toISOString() }]);
                }
            };

            // Render
            const isRunning = status.state === "running";
            const isPaused = status.state === "paused";
            const isIdle = status.state === "idle";

            return (
                <div>
                    {/* Header */}
                    <div className="header">
                        <div className="logo">
                            <div className="logo-dot" style={{ background: connected ? "#4ecdc4" : "#ff6b9d" }}></div>
                            <span className="logo-text">SYNAPSE</span>
                            <span className={"status-badge status-" + status.state}>{status.state}</span>
                        </div>
                        <div className="info-bar">
                            <span>Step: {status.step?.toLocaleString()}</span>
                            <span>Time: {status.elapsed_human}</span>
                            <span>Neurons: {status.total_neurons?.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="container">
                        <div className="main-grid">

                            {/* Left: Controls */}
                            <div>
                                {/* Training Control */}
                                <div className="card" style={{ marginBottom: 15 }}>
                                    <div className="card-header">‚ñ∂ Training Control</div>
                                    <div className="card-body">
                                        <div className="btn-group">
                                            {isIdle || isPaused ? (
                                                <button className="btn btn-success btn-block" onClick={isPaused ? resume : start}>
                                                    ‚ñ∂ {isPaused ? "RESUME" : "START"}
                                                </button>
                                            ) : null}
                                            {isRunning && (
                                                <button className="btn btn-warning btn-block" onClick={pause}>
                                                    ‚è∏ PAUSE
                                                </button>
                                            )}
                                        </div>
                                        {!isIdle && (
                                            <button className="btn btn-danger btn-block" onClick={stop}>
                                                ‚èπ STOP & SAVE
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {/* Stop Conditions */}
                                <div className="card" style={{ marginBottom: 15 }}>
                                    <div className="card-header">‚è± Stop Conditions</div>
                                    <div className="card-body">
                                        <div className="input-row">
                                            <div className="input-group">
                                                <label className="input-label">Max Steps</label>
                                                <input className="input" type="number" placeholder="100000"
                                                    value={maxSteps} onChange={e => setMaxSteps(e.target.value)} />
                                            </div>
                                            <div className="input-group">
                                                <label className="input-label">Max Hours</label>
                                                <input className="input" type="number" placeholder="8" step="0.5"
                                                    value={maxHours} onChange={e => setMaxHours(e.target.value)} />
                                            </div>
                                        </div>
                                        <div className="input-row">
                                            <div className="input-group">
                                                <label className="input-label">Target Œ¶</label>
                                                <input className="input" type="number" placeholder="0.7" step="0.1"
                                                    value={targetPhi} onChange={e => setTargetPhi(e.target.value)} />
                                            </div>
                                            <div className="input-group">
                                                <label className="input-label">Target Agency</label>
                                                <input className="input" type="number" placeholder="0.7" step="0.1"
                                                    value={targetAgency} onChange={e => setTargetAgency(e.target.value)} />
                                            </div>
                                        </div>
                                        <button className="btn btn-primary btn-block" onClick={setStopCond}>
                                            Apply Conditions
                                        </button>
                                    </div>
                                </div>

                                {/* Neurogenesis */}
                                <div className="card" style={{ marginBottom: 15 }}>
                                    <div className="card-header">üß¨ Neurogenesis</div>
                                    <div className="card-body">
                                        <label style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 12, cursor: "pointer" }}>
                                            <input type="checkbox" checked={neuroEnabled}
                                                onChange={e => setNeuroEnabled(e.target.checked)} />
                                            <span style={{ fontSize: 13 }}>Enable Neurogenesis</span>
                                        </label>
                                        <div className="input-row">
                                            <div className="input-group">
                                                <label className="input-label">Max Neurons</label>
                                                <input className="input" type="number" value={maxNeurons}
                                                    onChange={e => setMaxNeurons(e.target.value)} />
                                            </div>
                                            <div className="input-group">
                                                <label className="input-label">Threshold</label>
                                                <input className="input" type="number" step="0.05" value={growthThreshold}
                                                    onChange={e => setGrowthThreshold(e.target.value)} />
                                            </div>
                                        </div>
                                        <button className="btn btn-secondary btn-block" onClick={setNeuroCfg}>
                                            Update Config
                                        </button>
                                        <div style={{ marginTop: 10, fontSize: 11, color: "#4a5568" }}>
                                            Growth events: {status.growth_events || 0}
                                        </div>
                                    </div>
                                </div>

                                {/* Checkpoints */}
                                <div className="card">
                                    <div className="card-header">üíæ Checkpoints</div>
                                    <div className="card-body">
                                        <div className="btn-group">
                                            <button className="btn btn-primary btn-block" onClick={saveCkpt}>
                                                üíæ Save
                                            </button>
                                            <button className="btn btn-danger btn-block" onClick={resetModel}>
                                                üîÑ Reset
                                            </button>
                                        </div>
                                        <div className="checkpoint-list">
                                            {checkpoints.length === 0 ? (
                                                <div style={{ textAlign: "center", padding: 15, color: "#4a5568", fontSize: 12 }}>
                                                    No checkpoints yet
                                                </div>
                                            ) : (
                                                checkpoints.map((c, i) => (
                                                    <div key={i} className="checkpoint-item">
                                                        <div className="checkpoint-info">
                                                            <div className="checkpoint-name">{c.name}</div>
                                                            <div className="checkpoint-size">{c.size_mb?.toFixed(1)} MB</div>
                                                        </div>
                                                        <button className="btn btn-secondary" style={{ padding: "6px 12px", fontSize: 11 }}
                                                            onClick={() => loadCkpt(c.path)}>
                                                            Load
                                                        </button>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Center: Metrics */}
                            <div>
                                <div className="metrics-grid">
                                    <div className="metric-card">
                                        <div className="metric-label">IIT Œ¶ (Phi)</div>
                                        <div className="metric-value metric-phi">{(metrics.phi || 0).toFixed(3)}</div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="metric-label">Agency</div>
                                        <div className="metric-value metric-agency">{(metrics.mean_agency || 0).toFixed(3)}</div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="metric-label">Integration</div>
                                        <div className="metric-value metric-integration">{(metrics.integration_score || 0).toFixed(3)}</div>
                                    </div>
                                    <div className="metric-card">
                                        <div className="metric-label">Confidence</div>
                                        <div className="metric-value metric-confidence">{(metrics.meta_confidence || 0).toFixed(3)}</div>
                                    </div>
                                </div>

                                <div className="card">
                                    <div className="card-header">üìä Status</div>
                                    <div className="card-body">
                                        <pre style={{ fontSize: 11, color: "#6b7280", whiteSpace: "pre-wrap" }}>
{`Training Status: ${status.state}
Steps: ${status.step?.toLocaleString() || 0}
Time: ${status.elapsed_human || "0s"}
Samples: ${status.total_samples?.toLocaleString() || 0}
Neurons: ${status.total_neurons?.toLocaleString() || 0}

Metrics:
  Œ¶ (Phi):      ${(metrics.phi || 0).toFixed(4)} (target: >0.4)
  Agency:      ${(metrics.mean_agency || 0).toFixed(4)} (target: >0.7)
  Integration: ${(metrics.integration_score || 0).toFixed(4)} (target: >0.6)
  Confidence:  ${(metrics.meta_confidence || 0).toFixed(4)} (target: >0.6)`}
                                        </pre>
                                    </div>
                                </div>
                            </div>

                            {/* Right: Neuro & Chat */}
                            <div>
                                {/* Neurochemistry */}
                                <div className="card" style={{ marginBottom: 15 }}>
                                    <div className="card-header">üß™ Neurochemistry</div>
                                    <div className="card-body">
                                        <Gauge label="Dopamine" value={neuro.dopamine} color="#ffd93d" />
                                        <Gauge label="Serotonin" value={neuro.serotonin} color="#4ecdc4" />
                                        <Gauge label="Oxytocin" value={neuro.oxytocin} color="#a8e6cf" />
                                        <Gauge label="Cortisol" value={neuro.cortisol} color="#ff8c42" />
                                        <Gauge label="Norepinephrine" value={neuro.norepinephrine} color="#ff6b9d" />
                                    </div>
                                </div>

                                {/* Chat */}
                                <div className="card" style={{ height: 350 }}>
                                    <div className="card-header">üí¨ Chat</div>
                                    <div className="chat-container">
                                        <div className="chat-messages" ref={chatRef}>
                                            {messages.length === 0 ? (
                                                <div style={{ textAlign: "center", padding: 30, color: "#4a5568", fontSize: 12 }}>
                                                    Start conversation...
                                                </div>
                                            ) : (
                                                messages.map((m, i) => (
                                                    <div key={i} className="chat-message" style={{ textAlign: m.from === "user" ? "right" : "left" }}>
                                                        <div className={"chat-bubble chat-bubble-" + m.from}>
                                                            {m.text}
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                        <div className="chat-input-container">
                                            <input className="chat-input"
                                                value={chatInput}
                                                onChange={e => setChatInput(e.target.value)}
                                                onKeyDown={e => e.key === "Enter" && sendChat()}
                                                placeholder="Message..." />
                                            <button className="btn btn-primary" onClick={sendChat}>‚Üí</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        function Gauge({ label, value, color }) {
            return (
                <div className="gauge">
                    <div className="gauge-header">
                        <span className="gauge-label">{label}</span>
                        <span className="gauge-value" style={{ color }}>{Math.round(value * 100)}%</span>
                    </div>
                    <div className="gauge-bar">
                        <div className="gauge-fill" style={{ width: `${value * 100}%`, background: color }}></div>
                    </div>
                </div>
            );
        }

        // Mount
        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
